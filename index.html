<html>
  <head>
    <script src="lib/capstone.min.js"></script>
    <script src="lib/codemirror-compressed.js"></script>
    <script src="lib/matchbrackets.js"></script>
    <script src="lib/closebrackets.js"></script>
    <script src="lib/highlight.pack.js"></script>

    <link rel="stylesheet" href="css/codemirror.css" />
    <link rel="stylesheet" href="css/dracula.css" />

		<link rel="stylesheet" href="css/hl-default.css" />
    <!-- <link rel="stylesheet" href="css/hl-dracula.css" /> -->
    <link href='http://fonts.googleapis.com/css?family=Inconsolata:400,700' rel='stylesheet' type='text/css'>

  </head>
  <style>
    body {
      font-family: Inconsolata;  
    }
    .Codemirror pre {
      font-family: Inconsolata;
      font-size: 14px;
    }
    code {
      font-family: Inconsolata;
      font-size: 14px;
    }
    .btn {
      padding: 6px 12px;
      font-size: 16px;      
      border: 1px solid transparent;
      border-radius: 4px;
      outline: none;
      background-color: #f8f8f2 !important;
    }
    .btn:hover {
      background-color: #dddddd !important;
      cursor: pointer;
    }
    .wasm-error { background-color: orange; }
  </style>
  <body onload="begin()">
  	<div style="width: 1000px">
	    <h1>
	      WebAssembly Explorer
	    </h1>
	    <div style="padding-bottom: 20px;">
	    	This tool uses a custom build of SpiderMonkey to extract and disassemble compiled WebAssembly code. Paste your code below and click Compile or press Cmd/Ctrl-Enter.
	    </div>
	    <div style="padding-bottom: 10px;">
	    	<button id="compile" class="btn">Compile</button><img id="spinner" src="img/ripple.svg" style="vertical-align: middle; padding-left: 4px; visibility: hidden;" />
	    </div>
	    <table>
	      <tr>
	        <td style="font-weight: bold;">WebAssembly (S-Expression Format)</td>
	        <td style="font-weight: bold;">x86/64 (SpiderMonkey)</td>
	      </tr>
	      <tr>
	        <td width="600">
	    			<textarea id="wastCode"></textarea>      
	        </td>
	        <td width="400" style="vertical-align: top;">
	          <pre><code id="x86Code" class="x86asm" style="height: 500px;"></code></pre>
	        </td>
	      </tr>
	    </table>
	    Thanks to: CodeMirror, Highlight.js and Capstone.js.
		</div>

    <script type="text/javascript">
			hljs.initHighlightingOnLoad();

      var base64DecodeMap = [ // starts at 0x2B
        62, 0, 0, 0, 63, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61,
        0, 0, 0, 0, 0, 0, 0, // 0x3A-0x40
        0,  1,  2,  3,  4,  5,  6, 7,  8,  9, 10, 11, 12, 13, 14, 15, 16, 17, 18,
        19, 20, 21, 22, 23, 24, 25, 0, 0, 0, 0, 0, 0, // 0x5B-0x0x60
        26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43,
        44, 45, 46, 47, 48, 49, 50, 51];
      var base64DecodeMapOffset = 0x2B;
      var base64EOF = 0x3D;

      function decodeRestrictedBase64ToBytes(encoded) {
        var ch;
        var code;
        var code2;

        var len = encoded.length;
        var padding = encoded.charAt(len - 2) === '=' ? 2 : encoded.charAt(len - 1) === '=' ? 1 : 0;
        var decoded = new Uint8Array((encoded.length >> 2) * 3 - padding);

        for (var i = 0, j = 0; i < encoded.length;) {
          ch = encoded.charCodeAt(i++);
          code = base64DecodeMap[ch - base64DecodeMapOffset];
          ch = encoded.charCodeAt(i++);
          code2 = base64DecodeMap[ch - base64DecodeMapOffset];
          decoded[j++] = (code << 2) | ((code2 & 0x30) >> 4);

          ch = encoded.charCodeAt(i++);
          if (ch == base64EOF) {
            return decoded;
          }
          code = base64DecodeMap[ch - base64DecodeMapOffset];
          decoded[j++] = ((code2 & 0x0f) << 4) | ((code & 0x3c) >> 2);

          ch = encoded.charCodeAt(i++);
          if (ch == base64EOF) {
            return decoded;
          }
          code2 = base64DecodeMap[ch - base64DecodeMapOffset];
          decoded[j++] = ((code & 0x03) << 6) | code2;
        }
        return decoded;
      }

      var input;
      var output;
      function begin() {
        input = CodeMirror.fromTextArea(document.getElementById('wastCode'), {
          lineNumbers: true,
          // theme: "dracula",
          viewportMargin: Infinity,
          matchBrackets: true,
          autoCloseBrackets: true,
          tabSize: 2,
          indentWithTabs: false
        });
        input.setOption("extraKeys", {
				  'Cmd-Enter': function(cm) { compile(); },
				  'Ctrl-Enter': function(cm) { compile(); }
				});

        input.setSize(600, 500);
        input.getDoc().setValue('(module \n  (func $foo(param i32) (result i32) (i32.popcnt (get_local 0)))\n  (func $bar(param i32) (result i32) (call $foo (get_local 0)))\n)');
				output = document.getElementById('x86Code');
      }

			document.getElementById('compile').onclick = compile;

      function compile() {
        var wast = input.getDoc().getValue();
        function toAddress(n) {
          var s = n.toString(16);
          while (s.length < 6) {
            s = "0" + s;
          }
          return "0x" + s;
        }
        function reqListener () {
        	document.getElementById("spinner").style.visibility = "hidden";
          var json = JSON.parse(this.responseText);
          if (typeof json === "string") {
            var parseError = "wasm text error: parsing wasm text at ";
            if (json.indexOf(parseError) == 0) {
              var location = json.substring(parseError.length).split(":");
              var line = Number(location[0]) - 1;
              var column = Number(location[1]) - 1;
              var mark = input.markText({line: line, ch: column}, {line: line, ch: 1000}, {className: "wasm-error"});
              setTimeout(function () {
                mark.clear();
              }, 5000);  
            }
            // output.getDoc().setValue(json);
            output.innerHTML = json;
            return;  
          }
          var s = "";
          var cs = new capstone.Cs(capstone.ARCH_X86, capstone.MODE_64);
          for (var i = 0; i < json.length; i++) {
          	var code = json[i];
          	s += "\n.function_" + i + "\n\n";
            var csBuffer = decodeRestrictedBase64ToBytes(code);
            var instructions = cs.disasm(csBuffer, 0);
            instructions.forEach(function (instr) {
              s += toAddress(instr.address) + " " + instr.mnemonic + " " + instr.op_str + "\n";
            });
          }
          // output.getDoc().setValue(s);
          output.innerHTML = s;
          hljs.highlightBlock(output);
          cs.delete();
        }

        var xhr = new XMLHttpRequest();
        xhr.addEventListener("load", reqListener);
        xhr.open("POST", "http://54.235.66.121/tmp/wasm/wasm.php", true);
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded")
        xhr.send("wast=" + encodeURIComponent(wast).replace('%20', '+'));
        document.getElementById("spinner").style.visibility = 'visible';
      };
    </script>
  </body>
</html>